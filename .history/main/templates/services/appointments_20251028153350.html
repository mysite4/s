{% extends 'base.html' %}
{% load static %}

{% block content %}
<link rel="stylesheet" href="{% static 'css/dashboard.css' %}">

<div class="page-container fade-in">
  <h1 class="page-title">ğŸ“… Ù†Ø¸Ø§Ù… Ø§Ù„Ù…ÙˆØ§Ø¹ÙŠØ¯ ÙˆØ§Ù„Ø­Ø¬ÙˆØ²Ø§Øª</h1>

  <!-- Tabs -->
  <div class="tabs">
    <button class="tab-btn active" data-tab="add">Ø¥Ø¶Ø§ÙØ© Ù…ÙˆØ¹Ø¯ Ø¬Ø¯ÙŠØ¯</button>
    <button class="tab-btn" data-tab="list">Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…ÙˆØ§Ø¹ÙŠØ¯</button>
    <button class="tab-btn" data-tab="manage">ØªØ¹Ø¯ÙŠÙ„ Ø£Ùˆ Ø¥Ù„ØºØ§Ø¡ Ù…ÙˆØ¹Ø¯</button>
  </div>

  <!-- Ù…Ø­ØªÙˆÙ‰ Tabs -->
  <div class="tab-content" id="add">
    <h2>Ø¥Ø¶Ø§ÙØ© Ù…ÙˆØ¹Ø¯ Ø¬Ø¯ÙŠØ¯</h2>
    <form id="add-appointment-form">
      {% csrf_token %}
      <input type="text" name="patient_name" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø±ÙŠØ¶" required>
      <input type="date" name="date" required>
      <input type="time" name="time" required>
      <input type="text" name="doctor_name" placeholder="Ø§Ø³Ù… Ø§Ù„Ø·Ø¨ÙŠØ¨" required>
      <button type="submit" class="btn-main">Ø­ÙØ¸ Ø§Ù„Ù…ÙˆØ¹Ø¯</button>
    </form>
    <div id="form-message"></div>
  </div>

  <div class="tab-content" id="list" style="display:none;">
    <h2>Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…ÙˆØ§Ø¹ÙŠØ¯</h2>
    <table id="appointments-table" class="appointments-table">
      <thead>
        <tr>
          <th>Ø§Ø³Ù… Ø§Ù„Ù…Ø±ÙŠØ¶</th>
          <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
          <th>Ø§Ù„ÙˆÙ‚Øª</th>
          <th>Ø§Ù„Ø·Ø¨ÙŠØ¨</th>
        </tr>
      </thead>
      <tbody>
        {% for appointment in appointments %}
        <tr data-id="{{ appointment.id }}">
          <td>{{ appointment.patient_name }}</td>
          <td>{{ appointment.date }}</td>
          <td>{{ appointment.time }}</td>
          <td>{{ appointment.doctor_name }}</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  <div class="tab-content" id="manage" style="display:none;">
    <h2>ØªØ¹Ø¯ÙŠÙ„ Ø£Ùˆ Ø¥Ù„ØºØ§Ø¡ Ù…ÙˆØ¹Ø¯</h2>
    <select id="appointment-select">
      {% for appointment in appointments %}
      <option value="{{ appointment.id }}">{{ appointment.patient_name }} - {{ appointment.date }}</option>
      {% endfor %}
    </select>
    <button id="edit-btn" class="btn-alert">ØªØ¹Ø¯ÙŠÙ„</button>
    <button id="delete-btn" class="btn-secondary">Ø¥Ù„ØºØ§Ø¡</button>
  </div>
</div>

<script>
  // Ø§Ù„ØªØ¨Ø¯ÙŠÙ„ Ø¨ÙŠÙ† Tabs
  const tabButtons = document.querySelectorAll('.tab-btn');
  const tabContents = document.querySelectorAll('.tab-content');
  tabButtons.forEach(btn => {
    btn.addEventListener('click', () => {
      tabButtons.forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      tabContents.forEach(c => c.style.display = 'none');
      document.getElementById(btn.getAttribute('data-tab')).style.display = 'block';
    });
  });

  // Ø¥Ø¶Ø§ÙØ© Ù…ÙˆØ¹Ø¯ Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… AJAX
  const form = document.getElementById('add-appointment-form');
  form.addEventListener('submit', function(e){
    e.preventDefault();
    const formData = new FormData(form);

    fetch("{% url 'appointments_ajax' %}", {
      method: "POST",
      headers: { 'X-Requested-With': 'XMLHttpRequest' },
      body: formData
    })
    .then(response => response.json())
    .then(data => {
      if(data.success){
        // Ø¥Ø¶Ø§ÙØ© Ø§Ù„ØµÙ Ø§Ù„Ø¬Ø¯ÙŠØ¯ ÙÙŠ Ø¬Ø¯ÙˆÙ„ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…ÙˆØ§Ø¹ÙŠØ¯
        const table = document.getElementById('appointments-table').querySelector('tbody');
        const tr = document.createElement('tr');
        tr.setAttribute('data-id', data.appointment.id);
        tr.innerHTML = `<td>${data.appointment.patient_name}</td>
                        <td>${data.appointment.date}</td>
                        <td>${data.appointment.time}</td>
                        <td>${data.appointment.doctor_name}</td>`;
        table.appendChild(tr);

        // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø®ÙŠØ§Ø± Ø§Ù„Ø¬Ø¯ÙŠØ¯ ÙÙŠ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„ØªØ¹Ø¯ÙŠÙ„/Ø§Ù„Ø­Ø°Ù
        const select = document.getElementById('appointment-select');
        const option = document.createElement('option');
        option.value = data.appointment.id;
        option.textContent = `${data.appointment.patient_name} - ${data.appointment.date}`;
        select.appendChild(option);

        form.reset();
        document.getElementById('form-message').textContent = "ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…ÙˆØ¹Ø¯ Ø¨Ù†Ø¬Ø§Ø­!";
      } else {
        document.getElementById('form-message').textContent = "Ø­Ø¯Ø« Ø®Ø·Ø£ØŒ Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.";
      }
    })
    .catch(err => console.log(err));
  });
</script>
{% endblock %}
