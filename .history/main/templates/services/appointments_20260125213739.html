{% extends 'base.html' %}
{% load static %}

{% block content %}
<link rel="stylesheet" href="{% static 'css/dashboard.css' %}">

<style>
.page-container {
    width: 95%;
    margin: 40px auto;
    font-family: 'Cairo', sans-serif;
}
.page-title {
    font-size: 32px;
    font-weight: bold;
    color: #0b1a5b;
    text-align: center;
}
.page-subtitle {
    text-align: center;
    color: #555;
    margin-bottom: 25px;
}
.tabs {
    display: flex;
    justify-content: center;
    gap: 10px;
    margin-bottom: 20px;
}
.tab-btn {
    padding: 10px 20px;
    border-radius: 10px;
    border: none;
    cursor: pointer;
    font-weight: bold;
}
.tab-btn.active {
    background: #0b1a5b;
    color: white;
}
.classic-table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 20px;
}
.classic-table th,
.classic-table td {
    padding: 10px;
    border: 1px solid #ddd;
    text-align: center;
}
.classic-table th {
    background: #0b1a5b;
    color: white;
}
.btn-main {
    background: #0d6efd;
    color: white;
    padding: 8px 16px;
    border: none;
    border-radius: 8px;
    cursor: pointer;
}
.no-print { margin-bottom: 15px; }

@media print {
  body * { visibility: hidden; }
  #print-area, #print-area * { visibility: visible; }
  #print-area { position: absolute; top: 0; left: 0; width: 100%; }
  .no-print { display: none !important; }
}
</style>

<div class="page-container">
  <h1 class="page-title">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…ÙˆØ§Ø¹ÙŠØ¯ ğŸ“…</h1>
  <p class="page-subtitle">Ø¥Ø¶Ø§ÙØ©ØŒ ØªØ¹Ø¯ÙŠÙ„ØŒ Ø¥Ù„ØºØ§Ø¡ ÙˆØ·Ø¨Ø§Ø¹Ø©</p>

  <!-- Tabs -->
  <div class="tabs no-print">
    <button class="tab-btn active" data-tab="list">Ù‚Ø§Ø¦Ù…Ø©</button>
    <button class="tab-btn" data-tab="manage">ØªØ¹Ø¯ÙŠÙ„ / Ø¥Ù„ØºØ§Ø¡</button>
    <button class="tab-btn" data-tab="add">Ø¥Ø¶Ø§ÙØ©</button>
  </div>

  <!-- Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…ÙˆØ§Ø¹ÙŠØ¯ -->
  <div id="list">
    <button onclick="window.print()" class="btn-main no-print">ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø©</button>
    <div id="print-area">
      <table class="classic-table">
        <thead>
          <tr>
            <th>#</th>
            <th>Ø§Ù„Ù…Ø±ÙŠØ¶</th>
            <th>Ø§Ù„Ù‡Ø§ØªÙ</th>
            <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
            <th>Ø§Ù„ÙˆÙ‚Øª</th>
            <th>Ø§Ù„Ø·Ø¨ÙŠØ¨</th>
          </tr>
        </thead>
        <tbody>
          {% for a in appointments %}
          <tr>
            <td>{{ forloop.counter }}</td>
            <td>{{ a.name }}</td>
            <td>{{ a.phone }}</td>
            <td>{{ a.date }}</td>
            <td>{{ a.time }}</td>
            <td>{{ a.doctor.name }}</td>
          </tr>
          {% empty %}
          <tr>
            <td colspan="6">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…ÙˆØ§Ø¹ÙŠØ¯</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>

  <!-- ØªØ¹Ø¯ÙŠÙ„ / Ø¥Ù„ØºØ§Ø¡ -->
  <div id="manage" style="display:none" class="no-print">
    <h3>ØªØ¹Ø¯ÙŠÙ„ Ø£Ùˆ Ø¥Ù„ØºØ§Ø¡ Ù…ÙˆØ¹Ø¯</h3>

    <select id="appointment-select">
      <option value="">Ø§Ø®ØªØ± Ù…ÙˆØ¹Ø¯</option>
      {% for a in appointments %}
      <option value="{{ a.id }}"
        data-name="{{ a.name }}"
        data-phone="{{ a.phone }}"
        data-date="{{ a.date }}"
        data-time="{{ a.time }}">
        {{ a.name }} - {{ a.date }}
      </option>
      {% endfor %}
    </select>

    <br><br>

    <input id="patient-name-input" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø±ÙŠØ¶">
    <input id="phone-input" placeholder="Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ">
    <input type="date" id="date-input">
    <input type="time" id="time-input">

    <br><br>
    <button id="edit-btn" class="btn-main">ØªØ¹Ø¯ÙŠÙ„</button>
    <button id="delete-btn" class="btn-main" style="background:#dc3545">Ø¥Ù„ØºØ§Ø¡</button>
  </div>

  <!-- Ø¥Ø¶Ø§ÙØ© Ù…ÙˆØ¹Ø¯ -->
  <div id="add" style="display:none" class="no-print">
    <h3>Ø¥Ø¶Ø§ÙØ© Ù…ÙˆØ¹Ø¯</h3>

    <form id="add-appointment-form">
      <input name="name" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø±ÙŠØ¶" required>
      <input name="phone" placeholder="Ø§Ù„Ù‡Ø§ØªÙ" required>
      <input name="email" placeholder="Ø§Ù„Ø¨Ø±ÙŠØ¯">
      <select name="doctor" required>
        <option value="">Ø§Ø®ØªØ± Ø·Ø¨ÙŠØ¨</option>
        {% for d in doctors %}
        <option value="{{ d.id }}">{{ d.name }}</option>
        {% endfor %}
      </select>
      <input type="date" name="date" required>
      <input type="time" name="time" required>
      <textarea name="message" placeholder="Ù…Ù„Ø§Ø­Ø¸Ø§Øª"></textarea>
      <input type="number" name="paid_amount" value="0">
      <button class="btn-main">Ø¥Ø¶Ø§ÙØ©</button>
    </form>
  </div>
</div>

<script>
// Tabs
document.querySelectorAll('.tab-btn').forEach(btn => {
  btn.addEventListener('click', () => {
    document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    document.getElementById('list').style.display = 'none';
    document.getElementById('manage').style.display = 'none';
    document.getElementById('add').style.display = 'none';
    document.getElementById(btn.dataset.tab).style.display = 'block';
  });
});

// ØªØ¹Ø¨Ø¦Ø© Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªØ¹Ø¯ÙŠÙ„
document.getElementById('appointment-select').addEventListener('change', function () {
  const o = this.selectedOptions[0];
  if (!o) return;

  document.getElementById('patient-name-input').value = o.dataset.name;
  document.getElementById('phone-input').value = o.dataset.phone;
  document.getElementById('date-input').value = o.dataset.date;
  document.getElementById('time-input').value = o.dataset.time;
});

// ØªØ¹Ø¯ÙŠÙ„ Ù…ÙˆØ¹Ø¯
document.getElementById('edit-btn').addEventListener('click', function () {
  const id = document.getElementById('appointment-select').value;
  if (!id) return alert('Ø§Ø®ØªØ§Ø±ÙŠ Ù…ÙˆØ¹Ø¯');

  const f = new FormData();
  f.append('appointment_id', id);
  f.append('patient_name', document.getElementById('patient-name-input').value);
  f.append('phone', document.getElementById('phone-input').value);
  f.append('date', document.getElementById('date-input').value);
  f.append('time', document.getElementById('time-input').value);

  fetch("{% url 'edit_appointment' %}", {
    method: 'POST',
    headers: { 'X-CSRFToken': '{{ csrf_token }}' },
    body: f
  })
  .then(r => r.json())
  .then(d => {
    if (d.success) location.reload();
    else alert('ÙØ´Ù„ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„');
  });
});

// Ø­Ø°Ù Ù…ÙˆØ¹Ø¯
document.getElementById('delete-btn').addEventListener('click', function () {
  const id = document.getElementById('appointment-select').value;
  if (!id) return alert('Ø§Ø®ØªØ§Ø±ÙŠ Ù…ÙˆØ¹Ø¯');
  if (!confirm('Ù‡Ù„ Ø£Ù†ØªÙ Ù…ØªØ£ÙƒØ¯Ø© Ù…Ù† Ø§Ù„Ø¥Ù„ØºØ§Ø¡ØŸ')) return;

  const f = new FormData();
  f.append('appointment_id', id);

  fetch("{% url 'delete_appointment' %}", {
    method: 'POST',
    headers: { 'X-CSRFToken': '{{ csrf_token }}' },
    body: f
  })
  .then(r => r.json())
  .then(d => {
    if (d.success) location.reload();
    else alert('ÙØ´Ù„ Ø§Ù„Ø­Ø°Ù');
  });
});

// Ø¥Ø¶Ø§ÙØ© Ù…ÙˆØ¹Ø¯
document.getElementById('add-appointment-form').addEventListener('submit', function (e) {
  e.preventDefault();

  fetch("{% url 'add_appointment' %}", {
    method: 'POST',
    headers: { 'X-CSRFToken': '{{ csrf_token }}' },
    body: new FormData(this)
  })
  .then(r => r.json())
  .then(d => {
    if (d.success) location.reload();
    else alert(d.error || 'Ø®Ø·Ø£');
  });
});
</script>

{% endblock %}
