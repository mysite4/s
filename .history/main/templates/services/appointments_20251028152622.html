{% extends 'base.html' %}
{% load static %}

{% block content %}
<link rel="stylesheet" href="{% static 'css/dashboard.css' %}">

<div class="page-container fade-in">
  <h1 class="page-title">📅 نظام المواعيد والحجوزات</h1>

  <!-- Tabs -->
  <div class="tabs">
    <button class="tab-btn active" data-tab="add">إضافة موعد جديد</button>
    <button class="tab-btn" data-tab="list">قائمة المواعيد</button>
    <button class="tab-btn" data-tab="manage">تعديل أو إلغاء موعد</button>
  </div>

  <!-- Tab: إضافة موعد -->
  <div class="tab-content" id="add">
    <h2>إضافة موعد جديد</h2>
    <form id="add-appointment-form">
      {% csrf_token %}
      {{ form.as_p }}
      <button type="submit" class="btn-main">حفظ الموعد</button>
    </form>
    <div id="add-msg"></div>
  </div>

  <!-- Tab: قائمة المواعيد -->
  <div class="tab-content" id="list" style="display:none;">
    <h2>قائمة المواعيد</h2>
    <table class="appointments-table" id="appointments-table">
      <thead>
        <tr>
          <th>اسم المريض</th>
          <th>التاريخ</th>
          <th>الوقت</th>
          <th>الطبيب</th>
        </tr>
      </thead>
      <tbody>
        {% for appointment in appointments %}
        <tr data-id="{{ appointment.id }}">
          <td>{{ appointment.patient_name }}</td>
          <td>{{ appointment.date }}</td>
          <td>{{ appointment.time }}</td>
          <td>{{ appointment.doctor_name }}</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  <!-- Tab: تعديل/حذف موعد -->
  <div class="tab-content" id="manage" style="display:none;">
    <h2>تعديل أو إلغاء موعد</h2>
    <select id="appointment-select">
      <option value="">اختر موعد</option>
      {% for appointment in appointments %}
      <option value="{{ appointment.id }}">{{ appointment.patient_name }} - {{ appointment.date }}</option>
      {% endfor %}
    </select>
    <form id="edit-appointment-form" style="display:none;">
      {% csrf_token %}
      {{ form.as_p }}
      <button type="submit" class="btn-alert">تعديل</button>
      <button type="button" id="delete-btn" class="btn-secondary">إلغاء</button>
    </form>
    <div id="edit-msg"></div>
  </div>
</div>

<script>
// Tabs
const tabButtons = document.querySelectorAll('.tab-btn');
const tabContents = document.querySelectorAll('.tab-content');
tabButtons.forEach(btn => {
  btn.addEventListener('click', () => {
    tabButtons.forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    tabContents.forEach(c => c.style.display='none');
    document.getElementById(btn.dataset.tab).style.display = 'block';
  });
});

// إضافة موعد Ajax
const addForm = document.getElementById('add-appointment-form');
addForm.addEventListener('submit', function(e){
  e.preventDefault();
  const formData = new FormData(addForm);
  fetch("", {
    method: "POST",
    headers: {'X-Requested-With':'XMLHttpRequest'},
    body: formData
  })
  .then(res => res.json())
  .then(data => {
    const msgDiv = document.getElementById('add-msg');
    if(data.success){
      msgDiv.innerHTML = "تم إضافة الموعد بنجاح!";
      addAppointmentToTables(data.appointment);
      addForm.reset();
    } else {
      msgDiv.innerHTML = "حصل خطأ!";
    }
  });
});

// إضافة الموعد الجديد للجداول والـselect
function addAppointmentToTables(appointment){
  // جدول قائمة المواعيد
  const tbody = document.querySelector('#appointments-table tbody');
  const tr = document.createElement('tr');
  tr.dataset.id = appointment.id;
  tr.innerHTML = `<td>${appointment.patient_name}</td>
                  <td>${appointment.date}</td>
                  <td>${appointment.time}</td>
                  <td>${appointment.doctor_name}</td>`;
  tbody.appendChild(tr);

  // select للتعديل
  const select = document.getElementById('appointment-select');
  const option = document.createElement('option');
  option.value = appointment.id;
  option.textContent = `${appointment.patient_name} - ${appointment.date}`;
  select.appendChild(option);
}

// اختيار موعد للتعديل
const select = document.getElementById('appointment-select');
const editForm = document.getElementById('edit-appointment-form');
const deleteBtn = document.getElementById('delete-btn');
let selectedId = null;

select.addEventListener('change', function(){
  selectedId = this.value;
  if(selectedId){
    editForm.style.display = 'block';
    // جلب بيانات الموعد من الجدول
    const row = document.querySelector(`#appointments-table tr[data-id='${selectedId}']`);
    editForm.querySelector('input[name="patient_name"]').value = row.children[0].textContent;
    editForm.querySelector('input[name="date"]').value = row.children[1].textContent;
    editForm.querySelector('input[name="time"]').value = row.children[2].textContent;
    editForm.querySelector('input[name="doctor_name"]').value = row.children[3].textContent;
  } else {
    editForm.style.display = 'none';
  }
});

// تعديل الموعد Ajax
editForm.addEventListener('submit', function(e){
  e.preventDefault();
  const formData = new FormData(editForm);
  formData.append('id', selectedId);
  fetch("", {
    method: "PUT",
    headers: {'X-Requested-With':'XMLHttpRequest'},
    body: formData
  })
  .then(res => res.json())
  .then(data => {
    const msgDiv = document.getElementById('edit-msg');
    if(data.success){
      msgDiv.innerHTML = "تم تعديل الموعد!";
      // تحديث الجدول
      const row = document.querySelector(`#appointments-table tr[data-id='${selectedId}']`);
      row.children[0].textContent = data.appointment.patient_name;
      row.children[1].textContent = data.appointment.date;
      row.children[2].textContent = data.appointment.time;
      row.children[3].textContent = data.appointment.doctor_name;

      // تحديث select
      const option = select.querySelector(`option[value='${selectedId}']`);
      option.textContent = `${data.appointment.patient_name} - ${data.appointment.date}`;
    } else {
      msgDiv.innerHTML = "حصل خطأ في التعديل!";
    }
  });
});

// حذف الموعد Ajax
deleteBtn.addEventListener('click', function(){
  if(!selectedId) return;
  if(!confirm('هل أنت متأكد من الحذف؟')) return;
  fetch("", {
    method: "DELETE",
    headers: {
      'X-Requested-With':'XMLHttpRequest',
      'Content-Type':'application/json'
    },
    body: JSON.stringify({'id': selectedId})
  })
  .then(res => res.json())
  .then(data => {
    if(data.success){
      // حذف من الجدول
      const row = document.querySelector(`#appointments-table tr[data-id='${selectedId}']`);
      row.remove();
      // حذف من select
      const option = select.querySelector(`option[value='${selectedId}']`);
      option.remove();
      // إعادة تعيين الفورم
      editForm.reset();
      editForm.style.display = 'none';
      select.value = '';
      document.getElementById('edit-msg').innerHTML = "تم الحذف!";
    }
  });
});
</script>
{% endblock %}
