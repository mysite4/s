{% extends 'base.html' %}
{% load static %}

{% block content %}
<link rel="stylesheet" href="{% static 'css/dashboard.css' %}">

<div class="page-container fade-in">
  <h1 class="page-title">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…ÙˆØ§Ø¹ÙŠØ¯ğŸ“… </h1>

  <!-- Tabs -->
  <div class="tabs">
    <button class="tab-btn active" data-tab="list">Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…ÙˆØ§Ø¹ÙŠØ¯</button>
    <button class="tab-btn" data-tab="manage">ØªØ¹Ø¯ÙŠÙ„ Ø£Ùˆ Ø¥Ù„ØºØ§Ø¡ Ù…ÙˆØ¹Ø¯</button>
    <button class="tab-btn" data-tab="add">Ø¥Ø¶Ø§ÙØ© Ù…ÙˆØ¹Ø¯ Ø¬Ø¯ÙŠØ¯</button>
  </div>

  <!-- Ù…Ø­ØªÙˆÙ‰ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…ÙˆØ§Ø¹ÙŠØ¯ -->
  <div class="tab-content" id="list">
    <h2>Ø§Ù„Ù…ÙˆØ§Ø¹ÙŠØ¯ Ø§Ù„Ù…Ø­Ø¬ÙˆØ²Ø©</h2>
    <table id="appointments-table" class="appointments-table">
      <thead>
        <tr>
          <th>Ø§Ø³Ù… Ø§Ù„Ù…Ø±ÙŠØ¶</th>
          <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
          <th>Ø§Ù„ÙˆÙ‚Øª</th>
          <th>Ø§Ù„Ø·Ø¨ÙŠØ¨</th>
        </tr>
      </thead>
      <tbody>
        {% for appointment in appointments %}
        <tr data-id="{{ appointment.id }}">
          <td>{{ appointment.name }}</td>
          <td>{{ appointment.date }}</td>
          <td>{{ appointment.time }}</td>
          <td>{{ appointment.doctor.name }}</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  <!-- Ù…Ø­ØªÙˆÙ‰ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„/Ø§Ù„Ø­Ø°Ù -->
  <div class="tab-content" id="manage" style="display:none;">
    <h2>ØªØ¹Ø¯ÙŠÙ„ Ø£Ùˆ Ø¥Ù„ØºØ§Ø¡ Ù…ÙˆØ¹Ø¯</h2>
    <select id="appointment-select">
      <option value="" disabled selected>Ø§Ø®ØªØ± Ù…ÙˆØ¹Ø¯</option>
      {% for appointment in appointments %}
      <option value="{{ appointment.id }}">{{ appointment.name }} - {{ appointment.date }}</option>
      {% endfor %}
    </select>
    <button id="edit-btn" class="btn-alert">ØªØ¹Ø¯ÙŠÙ„</button>
    <button id="delete-btn" class="btn-secondary">Ø¥Ù„ØºØ§Ø¡</button>

    <div id="edit-form-container" style="display:none; text-align:right; margin-top:20px;">
      <h3>ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…ÙˆØ¹Ø¯</h3>
      <form id="edit-appointment-form">
        {% csrf_token %}
        <input type="hidden" name="appointment_id" id="edit-appointment-id">
        <input type="text" name="patient_name" id="edit-patient-name" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø±ÙŠØ¶" required>
        <input type="date" name="date" id="edit-date" required>
        <input type="time" name="time" id="edit-time" required>
        <input type="text" name="doctor_name" id="edit-doctor-name" placeholder="Ø§Ø³Ù… Ø§Ù„Ø·Ø¨ÙŠØ¨" required>
        <button type="submit" class="btn-main">Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª</button>
      </form>
    </div>
  </div>

  <!-- Ù…Ø­ØªÙˆÙ‰ Ø¥Ø¶Ø§ÙØ© Ù…ÙˆØ¹Ø¯ Ø¬Ø¯ÙŠØ¯ -->
  <div class="tab-content" id="add" style="display:none;">
    <h2>Ø¥Ø¶Ø§ÙØ© Ù…ÙˆØ¹Ø¯ Ø¬Ø¯ÙŠØ¯</h2>
    <form id="add-appointment-form">
      {% csrf_token %}
      <input type="text" name="patient_name" id="add-patient-name" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø±ÙŠØ¶" required>
      <input type="date" name="date" id="add-date" required>
      <input type="time" name="time" id="add-time" required>
      <input type="text" name="doctor_name" id="add-doctor-name" placeholder="Ø§Ø³Ù… Ø§Ù„Ø·Ø¨ÙŠØ¨" required>
      <button type="submit" class="btn-main">Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…ÙˆØ¹Ø¯</button>
    </form>
  </div>
</div>

<script>
  // Ø§Ù„ØªØ¨Ø¯ÙŠÙ„ Ø¨ÙŠÙ† Tabs
  const tabButtons = document.querySelectorAll('.tab-btn');
  const tabContents = document.querySelectorAll('.tab-content');
  tabButtons.forEach(btn => {
    btn.addEventListener('click', () => {
      tabButtons.forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      tabContents.forEach(c => c.style.display = 'none');
      document.getElementById(btn.getAttribute('data-tab')).style.display = 'block';
    });
  });

  // Ø¹Ø±Ø¶ Ù†Ù…ÙˆØ°Ø¬ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…ÙˆØ¹Ø¯ Ø¹Ù†Ø¯ Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ ØªØ¹Ø¯ÙŠÙ„
  const editBtn = document.getElementById('edit-btn');
  const editFormContainer = document.getElementById('edit-form-container');

  editBtn.addEventListener('click', () => {
    const select = document.getElementById('appointment-select');
    const selectedOption = select.options[select.selectedIndex];
    if(!selectedOption.value) return alert('Ø§Ø®ØªØ± Ù…ÙˆØ¹Ø¯Ø§Ù‹ Ø£ÙˆÙ„Ø§Ù‹');

    const appointmentId = selectedOption.value;
    const row = document.querySelector(`#appointments-table tr[data-id='${appointmentId}']`);
    const cells = row.children;

    document.getElementById('edit-appointment-id').value = appointmentId;
    document.getElementById('edit-patient-name').value = cells[0].textContent;
    document.getElementById('edit-date').value = cells[1].textContent;
    document.getElementById('edit-time').value = cells[2].textContent;
    document.getElementById('edit-doctor-name').value = cells[3].textContent;

    editFormContainer.style.display = 'block';
  });

  // Ø¥Ø±Ø³Ø§Ù„ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…ÙˆØ¹Ø¯ Ø¥Ù„Ù‰ Ø§Ù„Ø³ÙŠØ±ÙØ±
  document.getElementById('edit-appointment-form').addEventListener('submit', function(e) {
    e.preventDefault();
    const formData = new FormData(this);
    
    fetch("{% url 'edit_appointment' %}", {
      method: "POST",
      headers: { 'X-CSRFToken': formData.get('csrfmiddlewaretoken') },
      body: formData
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        alert("ØªÙ… Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª Ø¨Ù†Ø¬Ø§Ø­ âœ…");
        location.reload();
      } else {
        alert("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø­ÙØ¸ âŒ");
      }
    });
  });

  // Ø¥Ø±Ø³Ø§Ù„ Ø¥Ø¶Ø§ÙØ© Ù…ÙˆØ¹Ø¯ Ø¬Ø¯ÙŠØ¯ Ø¥Ù„Ù‰ Ø§Ù„Ø³ÙŠØ±ÙØ±
  document.getElementById('add-appointment-form').addEventListener('submit', function(e) {
    e.preventDefault();
    const formData = new FormData(this);

    fetch("{% url 'add_appointment' %}", {
      method: "POST",
      headers: { 'X-CSRFToken': formData.get('csrfmiddlewaretoken') },
      body: formData
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        alert("ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…ÙˆØ¹Ø¯ Ø¨Ù†Ø¬Ø§Ø­ âœ…");
        location.reload();
      } else {
        alert("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø¥Ø¶Ø§ÙØ© âŒ: " + (data.error || ""));
      }
    });
  });
</script>

<style>
  /* ØªØ­Ø³ÙŠÙ† Ø´ÙƒÙ„ Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù…ÙˆØ§Ø¹ÙŠØ¯ */
  .appointments-table {
    width: 80%;
    margin: 20px auto;
    border-collapse: collapse;
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    background: #fff;
    border-radius: 10px;
    overflow: hidden;
  }
  .appointments-table th, .appointments-table td {
    padding: 12px 15px;
    text-align: center;
  }
  .appointments-table thead {
    background: linear-gradient(to right, #1976d2, #0b1a5b);
    color: #fff;
    font-weight: bold;
  }
  .appointments-table tbody tr:nth-child(even) {
    background: #f4f4f4;
  }
  .appointments-table tbody tr:hover {
    background: #e0e0e0;
    cursor: pointer;
  }
</style>
{% endblock %}
