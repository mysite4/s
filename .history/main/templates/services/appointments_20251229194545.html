{% extends 'base.html' %}
{% load static %}

{% block content %}
<link rel="stylesheet" href="{% static 'css/dashboard.css' %}">

<style>
/* ===== Ø¬Ø¯ÙˆÙ„ ÙƒÙ„Ø§Ø³ÙŠÙƒÙŠ ===== */
.classic-table {
  width: 100%;
  border-collapse: collapse;
  margin-top: 20px;
  background: #fff;
  font-size: 15px;
}

.classic-table th,
.classic-table td {
  border: 1px solid #ddd;
  padding: 10px;
  text-align: center;
}

.classic-table th {
  background-color: #f5f5f5;
  font-weight: bold;
}

.classic-table tr:nth-child(even) {
  background-color: #fafafa;
}

.classic-table tr:hover {
  background-color: #eef6ff;
}

/* ===== Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© ===== */
@media print {
  body * {
    visibility: hidden;
  }

  #print-area, #print-area * {
    visibility: visible;
  }

  #print-area {
    position: absolute;
    left: 0;
    top: 0;
    width: 100%;
  }

  .no-print {
    display: none !important;
  }
}
</style>

<div class="page-container fade-in">
  <h1 class="page-title">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…ÙˆØ§Ø¹ÙŠØ¯ ğŸ“…</h1>

  <!-- Tabs -->
  <div class="tabs no-print">
    <button class="tab-btn active" data-tab="list">Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…ÙˆØ§Ø¹ÙŠØ¯</button>
    <button class="tab-btn" data-tab="manage">ØªØ¹Ø¯ÙŠÙ„ Ø£Ùˆ Ø¥Ù„ØºØ§Ø¡ Ù…ÙˆØ¹Ø¯</button>
    <button class="tab-btn" data-tab="add">Ø¥Ø¶Ø§ÙØ© Ù…ÙˆØ¹Ø¯ Ø¬Ø¯ÙŠØ¯</button>
  </div>

  <!-- Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…ÙˆØ§Ø¹ÙŠØ¯ -->
  <div class="tab-content" id="list">

    <div class="no-print" style="text-align:left; margin-bottom:10px;">
      <button onclick="printTable()" class="btn-main">ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„Ø¬Ø¯ÙˆÙ„</button>
    </div>

    <div id="print-area">
      <h2 style="text-align:center;">Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù…ÙˆØ§Ø¹ÙŠØ¯</h2>

      <table class="classic-table">
        <thead>
          <tr>
            <th>#</th>
            <th>Ø§Ø³Ù… Ø§Ù„Ù…Ø±ÙŠØ¶</th>
            <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
            <th>Ø§Ù„ÙˆÙ‚Øª</th>
            <th>Ø§Ù„Ø·Ø¨ÙŠØ¨</th>
          </tr>
        </thead>
        <tbody>
          {% for appointment in appointments %}
          <tr>
            <td>{{ forloop.counter }}</td>
            <td>{{ appointment.name }}</td>
            <td>{{ appointment.date }}</td>
            <td>{{ appointment.time }}</td>
            <td>{{ appointment.doctor.name }}</td>
          </tr>
          {% empty %}
          <tr>
            <td colspan="5">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…ÙˆØ§Ø¹ÙŠØ¯</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>

  <!-- ØªØ¹Ø¯ÙŠÙ„ / Ø¥Ù„ØºØ§Ø¡ -->
  <div class="tab-content no-print" id="manage" style="display:none;">
    <h2>ØªØ¹Ø¯ÙŠÙ„ Ø£Ùˆ Ø¥Ù„ØºØ§Ø¡ Ù…ÙˆØ¹Ø¯</h2>

    <select id="appointment-select">
      <option value="" disabled selected>Ø§Ø®ØªØ± Ù…ÙˆØ¹Ø¯</option>
      {% for appointment in appointments %}
      <option value="{{ appointment.id }}">
        {{ appointment.name }} - {{ appointment.date }}
      </option>
      {% endfor %}
    </select>

    <br><br>

    <button id="edit-btn" class="btn-alert">ØªØ¹Ø¯ÙŠÙ„</button>
    <button id="delete-btn" class="btn-secondary">Ø¥Ù„ØºØ§Ø¡</button>
  </div>

  <!-- Ø¥Ø¶Ø§ÙØ© Ù…ÙˆØ¹Ø¯ -->
  <div class="tab-content no-print" id="add" style="display:none;">
    <h2>Ø¥Ø¶Ø§ÙØ© Ù…ÙˆØ¹Ø¯ Ø¬Ø¯ÙŠØ¯</h2>
    <form method="post">
      {% csrf_token %}
      <input type="text" name="patient_name" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø±ÙŠØ¶" required>
      <input type="date" name="date" required>
      <input type="time" name="time" required>
      <input type="text" name="doctor_name" placeholder="Ø§Ø³Ù… Ø§Ù„Ø·Ø¨ÙŠØ¨" required>
      <button type="submit" class="btn-main">Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…ÙˆØ¹Ø¯</button>
    </form>
  </div>
</div>

<script>
/* ===== Tabs ===== */
document.querySelectorAll('.tab-btn').forEach(btn => {
  btn.addEventListener('click', () => {
    document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    document.querySelectorAll('.tab-content').forEach(c => c.style.display = 'none');
    document.getElementById(btn.dataset.tab).style.display = 'block';
  });
});

/* ===== Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„Ø¬Ø¯ÙˆÙ„ ===== */
function printTable() {
  window.print();
}

/* ===== Ø¥Ù„ØºØ§Ø¡ Ù…ÙˆØ¹Ø¯ ===== */
document.getElementById('delete-btn').addEventListener('click', function () {
  const appointmentId = document.getElementById('appointment-select').value;

  if (!appointmentId) {
    alert('ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ù…ÙˆØ¹Ø¯ Ø£ÙˆÙ„Ø§Ù‹');
    return;
  }

  if (!confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø¥Ù„ØºØ§Ø¡ Ù‡Ø°Ø§ Ø§Ù„Ù…ÙˆØ¹Ø¯ØŸ')) return;

  const formData = new FormData();
  formData.append('appointment_id', appointmentId);

  fetch("{% url 'delete_appointment' %}", {
    method: 'POST',
    body: formData,
    headers: {
      'X-CSRFToken': '{{ csrf_token }}'
    }
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      alert('ØªÙ… Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ù…ÙˆØ¹Ø¯ Ø¨Ù†Ø¬Ø§Ø­');
      location.reload();
    } else {
      alert('ÙØ´Ù„ Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ù…ÙˆØ¹Ø¯');
    }
  });
});

/* ===== ØªØ¹Ø¯ÙŠÙ„ Ù…ÙˆØ¹Ø¯ ===== */
document.getElementById('edit-btn').addEventListener('click', function () {
  const appointmentId = document.getElementById('appointment-select').value;
  const patientName = document.getElementById('patient-name-input').value;
  const phone = document.getElementById('phone-input').value;
  const date = document.getElementById('date-input').value;
  const time = document.getElementById('time-input').value;

  if (!appointmentId || !patientName || !phone || !date || !time) {
    alert('ÙŠØ±Ø¬Ù‰ Ù…Ù„Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„!');
    return;
  }

  const formData = new FormData();
  formData.append('appointment_id', appointmentId);
  formData.append('patient_name', patientName);
  formData.append('phone', phone);
  formData.append('date', date);
  formData.append('time', time);

  fetch("{% url 'edit_appointment' %}", {
    method: 'POST',
    body: formData,
    headers: {
      'X-CSRFToken': '{{ csrf_token }}'
    }
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      alert('ØªÙ… ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…ÙˆØ¹Ø¯ Ø¨Ù†Ø¬Ø§Ø­');
      location.reload();
    } else {
      alert('ÙØ´Ù„ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…ÙˆØ¹Ø¯');
    }
  });
});

/* ===== Ø¥Ø¶Ø§ÙØ© Ù…ÙˆØ¹Ø¯ Ø¬Ø¯ÙŠØ¯ ===== */
document.getElementById('add-appointment-btn')?.addEventListener('click', function () {
  const patientName = document.getElementById('add-patient-name').value;
  const phone = document.getElementById('add-phone').value;
  const date = document.getElementById('add-date').value;
  const time = document.getElementById('add-time').value;
  const doctorName = document.getElementById('add-doctor-name').value;

  if (!patientName || !phone || !date || !time || !doctorName) {
    alert('ÙŠØ±Ø¬Ù‰ Ù…Ù„Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„!');
    return;
  }

  const formData = new FormData();
  formData.append('patient_name', patientName);
  formData.append('phone', phone);
  formData.append('date', date);
  formData.append('time', time);
  formData.append('doctor_name', doctorName);

  fetch("{% url 'add_appointment' %}", {
    method: 'POST',
    body: formData,
    headers: {
      'X-CSRFToken': '{{ csrf_token }}'
    }
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      alert('ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…ÙˆØ¹Ø¯ Ø¨Ù†Ø¬Ø§Ø­');
      location.reload();
    } else {
      alert('ÙØ´Ù„ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…ÙˆØ¹Ø¯: ' + (data.error || 'Ø­Ø¯Ø« Ø®Ø·Ø£'));
    }
  });
});
</script>

{% endblock %}
