{% extends 'base.html' %}
{% load static %}

{% block content %}
<link rel="stylesheet" href="{% static 'css/dashboard.css' %}">

<div class="page-container fade-in">
  <h1 class="page-title">ุฅุฏุงุฑุฉ ุงูููุงุนูุฏ๐ </h1>

  <!-- Tabs -->
  <div class="tabs">
    <button class="tab-btn active" data-tab="list">ูุงุฆูุฉ ุงูููุงุนูุฏ</button>
    <button class="tab-btn" data-tab="manage">ุชุนุฏูู ุฃู ุฅูุบุงุก ููุนุฏ</button>
    <button class="tab-btn" data-tab="add">ุฅุถุงูุฉ ููุนุฏ ุฌุฏูุฏ</button>
  </div>

  <!-- ูุงุฆูุฉ ุงูููุงุนูุฏ -->
  <div class="tab-content" id="list">
    <h2>ุงูููุงุนูุฏ ุงููุญุฌูุฒุฉ</h2>
    <table id="appointments-table" class="appointments-table">
      <thead>
        <tr>
          <th>ุงุณู ุงููุฑูุถ</th>
          <th>ุงูุชุงุฑูุฎ</th>
          <th>ุงูููุช</th>
          <th>ุงูุทุจูุจ</th>
        </tr>
      </thead>
      <tbody>
        {% for appointment in appointments %}
        <tr data-id="{{ appointment.id }}">
          <td>{{ appointment.name }}</td>
          <td>{{ appointment.date }}</td>
          <td>{{ appointment.time }}</td>
          <td>{{ appointment.doctor.name }}</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  <!-- ุชุนุฏูู / ุฅูุบุงุก -->
  <div class="tab-content" id="manage" style="display:none;">
    <h2>ุชุนุฏูู ุฃู ุฅูุบุงุก ููุนุฏ</h2>

    <select id="appointment-select">
      <option value="" disabled selected>ุงุฎุชุฑ ููุนุฏ</option>
      {% for appointment in appointments %}
      <option value="{{ appointment.id }}">
        {{ appointment.name }} - {{ appointment.date }}
      </option>
      {% endfor %}
    </select>

    <button id="edit-btn" class="btn-alert">ุชุนุฏูู</button>
    <button id="delete-btn" class="btn-secondary">ุฅูุบุงุก</button>

    <!-- ูููุฐุฌ ุงูุชุนุฏูู -->
    <div id="edit-form-container" style="display:none; text-align:right; margin-top:20px;">
      <h3>ุชุนุฏูู ุงูููุนุฏ</h3>
      <form id="edit-appointment-form">
        {% csrf_token %}
        <input type="hidden" name="appointment_id" id="edit-appointment-id">
        <input type="text" name="patient_name" id="edit-patient-name" placeholder="ุงุณู ุงููุฑูุถ" required>
        <input type="date" name="date" id="edit-date" required>
        <input type="time" name="time" id="edit-time" required>
        <input type="text" name="doctor_name" id="edit-doctor-name" placeholder="ุงุณู ุงูุทุจูุจ" required>
        <button type="submit" class="btn-main">ุญูุธ ุงูุชุนุฏููุงุช</button>
      </form>
    </div>
  </div>

  <!-- ุฅุถุงูุฉ ููุนุฏ -->
  <div class="tab-content" id="add" style="display:none;">
    <h2>ุฅุถุงูุฉ ููุนุฏ ุฌุฏูุฏ</h2>
    <form id="add-appointment-form">
      {% csrf_token %}
      <input type="text" name="patient_name" placeholder="ุงุณู ุงููุฑูุถ" required>
      <input type="date" name="date" required>
      <input type="time" name="time" required>
      <input type="text" name="doctor_name" placeholder="ุงุณู ุงูุทุจูุจ" required>
      <button type="submit" class="btn-main">ุฅุถุงูุฉ ุงูููุนุฏ</button>
    </form>
  </div>
</div>

<script>
/* Tabs */
document.querySelectorAll('.tab-btn').forEach(btn => {
  btn.addEventListener('click', () => {
    document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    document.querySelectorAll('.tab-content').forEach(c => c.style.display = 'none');
    document.getElementById(btn.dataset.tab).style.display = 'block';
  });
});

/* ุฒุฑ ุงูุชุนุฏูู */
document.getElementById('edit-btn').addEventListener('click', () => {
  const select = document.getElementById('appointment-select');
  if (!select.value) return alert('ุงุฎุชุฑ ููุนุฏ ุฃููุงู');

  const row = document.querySelector(`#appointments-table tr[data-id='${select.value}']`);
  const cells = row.children;

  document.getElementById('edit-appointment-id').value = select.value;
  document.getElementById('edit-patient-name').value = cells[0].textContent;
  document.getElementById('edit-date').value = cells[1].textContent;
  document.getElementById('edit-time').value = cells[2].textContent;
  document.getElementById('edit-doctor-name').value = cells[3].textContent;

  document.getElementById('edit-form-container').style.display = 'block';
});

/* ุญูุธ ุงูุชุนุฏูู */
document.getElementById('edit-appointment-form').addEventListener('submit', function(e) {
  e.preventDefault();
  const formData = new FormData(this);

  fetch("{% url 'edit_appointment' %}", {
    method: "POST",
    headers: { 'X-CSRFToken': formData.get('csrfmiddlewaretoken') },
    body: formData
  })
  .then(r => r.json())
  .then(d => {
    if (d.success) {
      alert("ุชู ุงูุชุนุฏูู ุจูุฌุงุญ โ");
      location.reload();
    } else {
      alert("ูุดู ุงูุชุนุฏูู โ");
    }
  });
});

/* ุฒุฑ ุงูุฅูุบุงุก (ุงูุญุฐู) โ */
document.getElementById('delete-btn').addEventListener('click', () => {
  const select = document.getElementById('appointment-select');
  if (!select.value) return alert('ุงุฎุชุฑ ููุนุฏ ุฃููุงู');

  if (!confirm("ูู ุฃูุช ูุชุฃูุฏ ูู ุฅูุบุงุก ูุฐุง ุงูููุนุฏุ")) return;

  const formData = new FormData();
  formData.append('appointment_id', select.value);
  formData.append('csrfmiddlewaretoken', '{{ csrf_token }}');

  fetch("{% url 'delete_appointment' %}", {
    method: "POST",
    body: formData
  })
  .then(r => r.json())
  .then(d => {
    if (d.success) {
      alert("ุชู ุฅูุบุงุก ุงูููุนุฏ โ");
      location.reload();
    } else {
      alert("ูุดู ุงูุฅูุบุงุก โ");
    }
  });
});
</script>

{% endblock %}
