{% extends 'base.html' %}
{% load static %}

{% block content %}
<link rel="stylesheet" href="{% static 'css/dashboard.css' %}">

<div class="page-container fade-in">
  <h1 class="page-title">ğŸ“… Ù†Ø¸Ø§Ù… Ø§Ù„Ù…ÙˆØ§Ø¹ÙŠØ¯ ÙˆØ§Ù„Ø­Ø¬ÙˆØ²Ø§Øª</h1>

  <!-- Tabs -->
  <div class="tabs">
    <button class="tab-btn active" data-tab="add">Ø¥Ø¶Ø§ÙØ© Ù…ÙˆØ¹Ø¯ Ø¬Ø¯ÙŠØ¯</button>
    <button class="tab-btn" data-tab="list">Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…ÙˆØ§Ø¹ÙŠØ¯</button>
    <button class="tab-btn" data-tab="manage">ØªØ¹Ø¯ÙŠÙ„ Ø£Ùˆ Ø¥Ù„ØºØ§Ø¡ Ù…ÙˆØ¹Ø¯</button>
  </div>

  <!-- Tab: Ø¥Ø¶Ø§ÙØ© Ù…ÙˆØ¹Ø¯ -->
  <div class="tab-content" id="add">
    <h2>Ø¥Ø¶Ø§ÙØ© Ù…ÙˆØ¹Ø¯ Ø¬Ø¯ÙŠØ¯</h2>
    <form id="add-appointment-form">
      {% csrf_token %}
      {{ form.as_p }}
      <button type="submit" class="btn-main">Ø­ÙØ¸ Ø§Ù„Ù…ÙˆØ¹Ø¯</button>
    </form>
    <div id="add-msg"></div>
  </div>

  <!-- Tab: Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…ÙˆØ§Ø¹ÙŠØ¯ -->
  <div class="tab-content" id="list" style="display:none;">
    <h2>Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…ÙˆØ§Ø¹ÙŠØ¯</h2>
    <table class="appointments-table" id="appointments-table">
      <thead>
        <tr>
          <th>Ø§Ø³Ù… Ø§Ù„Ù…Ø±ÙŠØ¶</th>
          <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
          <th>Ø§Ù„ÙˆÙ‚Øª</th>
          <th>Ø§Ù„Ø·Ø¨ÙŠØ¨</th>
        </tr>
      </thead>
      <tbody>
        {% for appointment in appointments %}
        <tr data-id="{{ appointment.id }}">
          <td>{{ appointment.patient_name }}</td>
          <td>{{ appointment.date }}</td>
          <td>{{ appointment.time }}</td>
          <td>{{ appointment.doctor_name }}</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  <!-- Tab: ØªØ¹Ø¯ÙŠÙ„/Ø­Ø°Ù Ù…ÙˆØ¹Ø¯ -->
  <div class="tab-content" id="manage" style="display:none;">
    <h2>ØªØ¹Ø¯ÙŠÙ„ Ø£Ùˆ Ø¥Ù„ØºØ§Ø¡ Ù…ÙˆØ¹Ø¯</h2>
    <select id="appointment-select">
      <option value="">Ø§Ø®ØªØ± Ù…ÙˆØ¹Ø¯</option>
      {% for appointment in appointments %}
      <option value="{{ appointment.id }}">{{ appointment.patient_name }} - {{ appointment.date }}</option>
      {% endfor %}
    </select>
    <form id="edit-appointment-form" style="display:none;">
      {% csrf_token %}
      {{ form.as_p }}
      <button type="submit" class="btn-alert">ØªØ¹Ø¯ÙŠÙ„</button>
      <button type="button" id="delete-btn" class="btn-secondary">Ø¥Ù„ØºØ§Ø¡</button>
    </form>
    <div id="edit-msg"></div>
  </div>
</div>

<script>
// Tabs
const tabButtons = document.querySelectorAll('.tab-btn');
const tabContents = document.querySelectorAll('.tab-content');
tabButtons.forEach(btn => {
  btn.addEventListener('click', () => {
    tabButtons.forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    tabContents.forEach(c => c.style.display='none');
    document.getElementById(btn.dataset.tab).style.display = 'block';
  });
});

// Ø¥Ø¶Ø§ÙØ© Ù…ÙˆØ¹Ø¯ Ajax
const addForm = document.getElementById('add-appointment-form');
addForm.addEventListener('submit', function(e){
  e.preventDefault();
  const formData = new FormData(addForm);
  fetch("", {
    method: "POST",
    headers: {'X-Requested-With':'XMLHttpRequest'},
    body: formData
  })
  .then(res => res.json())
  .then(data => {
    const msgDiv = document.getElementById('add-msg');
    if(data.success){
      msgDiv.innerHTML = "ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…ÙˆØ¹Ø¯ Ø¨Ù†Ø¬Ø§Ø­!";
      addAppointmentToTables(data.appointment);
      addForm.reset();
    } else {
      msgDiv.innerHTML = "Ø­ØµÙ„ Ø®Ø·Ø£!";
    }
  });
});

// Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…ÙˆØ¹Ø¯ Ø§Ù„Ø¬Ø¯ÙŠØ¯ Ù„Ù„Ø¬Ø¯Ø§ÙˆÙ„ ÙˆØ§Ù„Ù€select
function addAppointmentToTables(appointment){
  // Ø¬Ø¯ÙˆÙ„ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…ÙˆØ§Ø¹ÙŠØ¯
  const tbody = document.querySelector('#appointments-table tbody');
  const tr = document.createElement('tr');
  tr.dataset.id = appointment.id;
  tr.innerHTML = `<td>${appointment.patient_name}</td>
                  <td>${appointment.date}</td>
                  <td>${appointment.time}</td>
                  <td>${appointment.doctor_name}</td>`;
  tbody.appendChild(tr);

  // select Ù„Ù„ØªØ¹Ø¯ÙŠÙ„
  const select = document.getElementById('appointment-select');
  const option = document.createElement('option');
  option.value = appointment.id;
  option.textContent = `${appointment.patient_name} - ${appointment.date}`;
  select.appendChild(option);
}

// Ø§Ø®ØªÙŠØ§Ø± Ù…ÙˆØ¹Ø¯ Ù„Ù„ØªØ¹Ø¯ÙŠÙ„
const select = document.getElementById('appointment-select');
const editForm = document.getElementById('edit-appointment-form');
const deleteBtn = document.getElementById('delete-btn');
let selectedId = null;

select.addEventListener('change', function(){
  selectedId = this.value;
  if(selectedId){
    editForm.style.display = 'block';
    // Ø¬Ù„Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ÙˆØ¹Ø¯ Ù…Ù† Ø§Ù„Ø¬Ø¯ÙˆÙ„
    const row = document.querySelector(`#appointments-table tr[data-id='${selectedId}']`);
    editForm.querySelector('input[name="patient_name"]').value = row.children[0].textContent;
    editForm.querySelector('input[name="date"]').value = row.children[1].textContent;
    editForm.querySelector('input[name="time"]').value = row.children[2].textContent;
    editForm.querySelector('input[name="doctor_name"]').value = row.children[3].textContent;
  } else {
    editForm.style.display = 'none';
  }
});

// ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…ÙˆØ¹Ø¯ Ajax
editForm.addEventListener('submit', function(e){
  e.preventDefault();
  const formData = new FormData(editForm);
  formData.append('id', selectedId);
  fetch("", {
    method: "PUT",
    headers: {'X-Requested-With':'XMLHttpRequest'},
    body: formData
  })
  .then(res => res.json())
  .then(data => {
    const msgDiv = document.getElementById('edit-msg');
    if(data.success){
      msgDiv.innerHTML = "ØªÙ… ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…ÙˆØ¹Ø¯!";
      // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¬Ø¯ÙˆÙ„
      const row = document.querySelector(`#appointments-table tr[data-id='${selectedId}']`);
      row.children[0].textContent = data.appointment.patient_name;
      row.children[1].textContent = data.appointment.date;
      row.children[2].textContent = data.appointment.time;
      row.children[3].textContent = data.appointment.doctor_name;

      // ØªØ­Ø¯ÙŠØ« select
      const option = select.querySelector(`option[value='${selectedId}']`);
      option.textContent = `${data.appointment.patient_name} - ${data.appointment.date}`;
    } else {
      msgDiv.innerHTML = "Ø­ØµÙ„ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„!";
    }
  });
});

// Ø­Ø°Ù Ø§Ù„Ù…ÙˆØ¹Ø¯ Ajax
deleteBtn.addEventListener('click', function(){
  if(!selectedId) return;
  if(!confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ø­Ø°ÙØŸ')) return;
  fetch("", {
    method: "DELETE",
    headers: {
      'X-Requested-With':'XMLHttpRequest',
      'Content-Type':'application/json'
    },
    body: JSON.stringify({'id': selectedId})
  })
  .then(res => res.json())
  .then(data => {
    if(data.success){
      // Ø­Ø°Ù Ù…Ù† Ø§Ù„Ø¬Ø¯ÙˆÙ„
      const row = document.querySelector(`#appointments-table tr[data-id='${selectedId}']`);
      row.remove();
      // Ø­Ø°Ù Ù…Ù† select
      const option = select.querySelector(`option[value='${selectedId}']`);
      option.remove();
      // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„ÙÙˆØ±Ù…
      editForm.reset();
      editForm.style.display = 'none';
      select.value = '';
      document.getElementById('edit-msg').innerHTML = "ØªÙ… Ø§Ù„Ø­Ø°Ù!";
    }
  });
});
</script>
{% endblock %}
